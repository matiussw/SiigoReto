pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                script {
                    docker.image('gradle:6.8.3-jdk11').inside {
                        sh 'gradle clean build'
                    }
                }
            }
        }

        stage('Test with Serenity BDD') {
            steps {
                script {
                    docker.image('gradle:6.8.3-jdk11').inside {
                        sh 'gradle test aggregate'
                    }
                }
            }
        }

        stage('Publish Test Results') {
            steps {
                publishHTML([
                    reportDir: 'build/reports/tests/test',
                    reportFiles: 'index.html',
                    reportName: 'Test Report'
                ])
            }
        }

        stage('Run JMeter Tests') {
            steps {
                script {
                    docker.image('justb4/jmeter:5.4.1').inside {
                        sh 'jmeter -n -t ReqRes-Test/jmeter/Request_Api.jmx -l ReqRes-Test/jmeter/result.jtl'
                    }
                }
            }
        }

        stage('Publish JMeter Results') {
            steps {
                perfReport errorFailedThreshold: 0, errorUnstableThreshold: 0, sourceDataFiles: 'path/to/your/result.jtl'
            }
        }
    }

    post {
        always {
            junit 'build/test-results/test/*.xml'
        }
    }
}
